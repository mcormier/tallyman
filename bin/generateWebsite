#!/bin/bash

SCRIPTLOC=`dirname $0`
cd $SCRIPTLOC

# generatex xml data in the xslt directory
${SCRIPTLOC}/extractDBDataToXMLFile

WEB_ROOT=`${SCRIPTLOC}/getProperty webRoot`
HTMLOUTPUT_LOC=`${SCRIPTLOC}/getProperty outputHTMLFile`
THEME=`${SCRIPTLOC}/getProperty theme`
XML_DATA=`${SCRIPTLOC}/getProperty xmlDataFile`
ENABLE_GRAPHS=`${SCRIPTLOC}/getProperty enableGraphs`

XSL_LOC=${SCRIPTLOC}/../data/themes/${THEME}/xsl/createHTML.xsl 

# Transform the XML data to an HTML file with the XML style sheet
# for the current theme
xsltproc ${XSL_LOC} ${XML_DATA} > $HTMLOUTPUT_LOC

if [ $ENABLE_GRAPHS = "true" ]; then
  ${SCRIPTLOC}/../graphing/createGraphs
fi


# update the manifest
CACHE_MANIFEST=${SCRIPTLOC}/../data/themes/${THEME}/cache/cache.manifest

if [ -e ${CACHE_MANIFEST} ]; then
  NOW=`date +"%s"` ; sed "2 s/.*/#\ Version:$NOW/" \
  ${CACHE_MANIFEST} > $WEB_ROOT/cache.manifest
fi

