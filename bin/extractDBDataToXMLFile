#!/usr/bin/env ruby

require 'rubygems'
require 'builder'
require "sqlite3"

load '../config/config.properties'

def query_lift_data( db, query, lift_name, rep)
  return_value = '0'

  value = db.get_first_value query, lift_name, rep
  unless value.nil? then
    return_value = value
  end

  return_value
end


def get_svg_lift_name( name )
  lower = name.downcase
  replace_ampersand = lower.gsub(/&/, 'and')
  replace_ampersand.gsub(/\s+/, '')
end


begin
  x = Builder::XmlMarkup.new( :indent => 2 )
  db = SQLite3::Database.open @dbName
  x.instruct! :xml, :encoding => @xmlEncoding

  File.open( @xmlDataFile, 'w' ) do |out|

  out.puts x.data {
    x.settings {
      x.enableGraphs @enableGraphs
    }


    @outputQueries.each do |queryInfo|
      begin
        stm = db.prepare queryInfo[1]
        rs = stm.execute
        row = rs.next
        x.item{
          x.title queryInfo[0]
          x.value row.join "\s"
        }
      ensure
        stm.close
      end
    end

    x.lifts {
    @lifts.each do |lift|
      begin
        
        x.lift {
          x.name lift
          x.svgname get_svg_lift_name(lift)

          x.onerm query_lift_data( db, @liftQuery, lift, 1)
          x.threerm query_lift_data( db, @liftQuery, lift, 3)
          x.fiverm  query_lift_data( db, @liftQuery, lift, 5)
        }
      ensure
        #stm.close
      end
    end
    }
  }

 

  end

rescue SQLite3::Exception => e
  puts 'Exception occurred'
  puts e.message

ensure
  db.close if db
end
