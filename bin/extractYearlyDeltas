#!/usr/bin/env ruby
#
# Generates a data.xml that compares maximum lift info from year to year
#


require 'rubygems'
require 'builder'
require "sqlite3"

load '../config/config.properties'

# TODO - push to tallyman lib

def max_lift_for_year( db, lift_name, year)
  return_val = '0'
  query ='SELECT MAX(weight), day  FROM lifts WHERE name=? and reps=1 and date(day) < date(?);'
  year_str = year.to_s + '-12-31'

  value = db.get_first_value query, lift_name, year_str
  unless value.nil? then
    return_val = value
  end

  return_val
end




begin
  x = Builder::XmlMarkup.new( :indent => 2 )
  db = SQLite3::Database.open @dbName
  x.instruct! :xml, :encoding => @xmlEncoding

  File.open( @xmlDataFile, 'w' ) do |out|

  out.puts x.data {

    x.lifts {
    @lifts.each do |lift|
      begin
        
        x.lift {
          x.name lift
          x.max2012 max_lift_for_year( db, lift, 2012)
          x.max2013 max_lift_for_year( db, lift, 2013)
        }
      ensure
        #stm.close
      end
    end
    }
  }

 

  end

rescue SQLite3::Exception => e
  puts 'Exception occurred'
  puts e.message

ensure
  db.close if db
end
